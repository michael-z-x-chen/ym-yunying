var table;
$(document).ready(function () {
    table = $('#dataTables-user').DataTable({
        "responsive": true,
        "paginate": true,
        "processing": true,
        "serverSide": true,
        "searching": false,
        "ordering": false,
        "pagingType": 'full_numbers',
        "ajax": {
            "url": ctx + '/api/user/list',
            "type": 'post'
        },
        "columnDefs": [{
            "aTargets": [8],
            "mData": "download_link",
            "mRender": function (data) {
                var html = '<a class="btn btn-sm blue btn-outline filter-cancel" href="javascript:editUser(\'' + data.id + '\',\'' + data.name + '\',\'' + data.mobile + '\',\'' + data.email + '\')"><i class="fa fa-edit"></i>编辑</a>\n';
                html += '<a class="btn btn-sm purple btn-outline filter-cancel" href="javascript:addUserRole(\'' + data.id + '\',\'' + data.roleIds + '\')"><i class="fa fa-users"></i>分配角色</a>\n';
                html += '<a class="btn btn-sm yellow btn-outline filter-cancel" href="javascript:addUserProfile(\'' + data.id + '\',\'' + data.gantEnvs + '\')"><i class="fa fa-gears"></i>授权环境</a>';
                html += '<a class="btn btn-sm yellow btn-outline filter-cancel" href="javascript:addUserProject(\'' + data.id + '\',\'' + data.gantProject + '\')"><i class="fa fa-gears"></i>授权项目</a>';
                html += '<a class="btn btn-sm red btn-outline filter-cancel" href="javascript:deleteUser(' + data.id + ')"><i class="fa fa-remove"></i>删除</a>';

                return html;
            }
        }],
        "createdRow": function (row, data, index) {
            $('td', row).eq(4).attr('style', 'width:200px;word-wrap:break-word;');
        },
        "columns": [
            {"data": "name"},
            {"data": "mobile"},
            {"data": "email"},
            {"data": "roleNames"},
            {"data": "gantEnvNames"},
            {"data": "gantProjectName"},
            {
                "data": "status", "render": function (data) {
                    return data == 1 ? '启用' : '禁用';
                }
            },
            {
                "data": "createTime", "render": function (data) {
                    return (new Date(data)).Format("yyyy-MM-dd hh:mm:ss");
                }
            },
            {"data": null}
        ],
        "language": {
            "url": ctx + '/static/plugins/datatables/language-chinese.json'
        }
    });
});

function deleteUser(id) {
    commonFn.deleteData(id, ctx + "/api/user/delete", table);
}

var $addUserForm = $('#addUserForm');
var $addUserRoleForm = $('#addUserRoleForm');
var $addUserProfileForm = $('#addUserProfileForm');
var $addProjectForm = $('#addProjectForm');

function editUser(id, name, mobile, email) {
    $addUserForm.validate().resetForm();
    commonFn.removeClass();

    $("#id").val(id);
    $("#name").val(name);
    $("#mobile").val(mobile);
    $("#email").val(email);
    $("#passwordDiv").hide();
    $("#addUserModal").modal('show');
    $("#myModalLabel").html("编辑用户");
}

function addUserModal() {
    $addUserForm.validate().resetForm();
    commonFn.removeClass();
    commonFn.emptyVal();

    $("#passwordDiv").show();
    $("#myModalLabel").html("添加用户");
    $("#saveUserBtn").prop("disabled", false);
}

function addUserRole(userId, userRoleIds) {
    $addUserForm.validate().resetForm();
    commonFn.removeCheck();

    $(".checkbox-inline input[type='checkbox']").each(function () {
        var value = $(this).attr('value')
        for (var i = 0; i < userRoleIds.length; i++) {
            if (userRoleIds[i] == value) {
                $.uniform.update($(this).prop("checked", true));
            }
        }
    });

    $("#userId").val(userId);
    $("#addUserRoleModal").modal('show');
    $("#saveUserBtn").prop("disabled", false);
}

function addUserProfile(id, gantEnvs) {
    $addUserProfileForm.validate().resetForm();
    commonFn.removeCheck();

    $(".addUserProfileCheckBox input[type='checkbox']").each(function () {
        var value = $(this).attr('data-cache');
        var gantEnv = gantEnvs.split(',')
        for (var i = 0; i < gantEnv.length; i++) {
            if (gantEnv[i] == value) {
                $.uniform.update($(this).prop("checked", true));
            }
        }
    });

    $("#profileUserId").val(id);
    $("#addUserProfileModal").modal('show');
}

function addUserProject(id, gantProject) {
    $addProjectForm.validate().resetForm();
    commonFn.removeCheck();

    $(".addProjectCheckBox input[type='checkbox']").each(function () {
        var value = $(this).attr('data-cache');
        var projects = gantProject.split(',')
        for (var i = 0; i < projects.length; i++) {
            if (projects[i] == value) {
                $.uniform.update($(this).prop("checked", true));
            }
        }
    });

    $("#projectUserId").val(id);
    $("#addProjectModal").modal('show');
}

$(document).ready(function () {
    commonFn.formSubmit($addUserForm, "saveUserBtn", "addUserModal", "", function ($addUserForm) {
        addFormRule($addUserForm);
    });

    commonFn.formSubmit($addUserRoleForm, "saveUserRoleBtn", "addUserRoleModal", "", function ($addUserRoleForm) {
        addUserRoleFormRule($addUserRoleForm);
    });

    commonFn.formSubmit($addUserProfileForm, "saveUserProfileBtn", "addUserProfileModal", "授权成功", function ($addUserProfileForm) {
        //addUserProfileForm($addUserProfileForm);
    });

    commonFn.formSubmit($addProjectForm, "saveProjectBtn", "addProjectModal", "授权成功", function ($addProjectForm) {
        addProjectForm($addProjectForm);
    });
});

function addFormRule($form) {
    $form.find("input[name='name']").rules("add", {required: true, messages: {required: "请输入用户名"}});
    $form.find("input[name='password']").rules("add", {required: true, messages: {required: "请输入密码"}});
}

function addUserRoleFormRule($form) {
    $form.find("input[name='roleIds']").rules("add", {required: true, messages: {required: "请选择用户角色"}});
}

function addUserProfileForm($form2) {
    $form2.find("input[name='profileIds']").rules("add", {required: true, messages: {required: "请选择环境"}});
}

function addProjectForm($form) {
    $form.find("input[name='projectIds']").rules("add", {required: true, messages: {required: "请选择项目"}});
}



